name: Daily Kicker Data Update

on:
  schedule:
    # 1) Every Morning at 8:00 AM UTC (8am Winnersh Time)
    - cron: '0 8 * * *'
    
    # 2) Monday & Thursday Night at 8:00 PM UTC (For TNF/MNF Prep)
    - cron: '0 20 * * 1,4'
    
    # 3) Sunday: Run EVERY HOUR (00:00 to 23:00) for live weather/inactives
    - cron: '0 * * * 0'
    
  workflow_dispatch: # Allows manual trigger from the GitHub web interface

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write 

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Fetch full history to avoid shallow clone issues

      - name: 2. Set up Python Environment (3.10)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 3. Install Dependencies
        run: pip install -r requirements.txt

      - name: 4. Create Public Data Directory
        run: mkdir -p public

      - name: 5. Run Analysis Script
        run: python run_engine.py
        
      - name: 6. Commit and Push
        run: |
          # Configure the Bot Identity
          git config --global user.name "KickerGenius Bot"
          git config --global user.email "bot@kickergenius.com"
          
          # Stash any changes temporarily to pull cleanly
          git stash
          
          # Pull latest changes to avoid conflict
          git pull --rebase origin main
          
          # Apply our changes back
          git stash pop || echo "No stash to pop"
          
          # Check status before adding
          echo "--- Git Status Before Add ---"
          git status
          
          # Force add the specific file
          git add public/kicker_data.json
          
          # Check if there are actual changes to commit
          if git diff-index --quiet HEAD --; then
            echo "No changes detected (file matched exactly)."
          else
            git commit -m "Data Bot Update: Week ${{ github.event.inputs.week }} Kicker Projections"
            
            # Retry push logic in case of race condition
            n=0
            until [ "$n" -ge 5 ]
            do
               git pull --rebase origin main && git push && break
               n=$((n+1)) 
               sleep 5
            done
            
            echo "âœ… Changes pushed successfully."
          fi